{%extends 'base.html'%}




{%block title %} Task List {% endblock%}



{% block content %}


<body>

<h1> Tasks for Completion</h1>


{% if messages %}
  {% for message in messages %}

    <div class="alert alert-success alert-dismissable" role="alert">
      <button class="close" data-dismiss="alert">
        <small><sup>x</sup></small>
      </button>
    {{ message }}
  </div>
  {% endfor %}

{%endif %}
</br>




<form class="form-inline my-2 my-lg-0" method="POST">{% csrf_token %}
  

  <input class="form-control mr-sm-2" type="text" id="datepicker" placeholder="Date"  name="taskdate" >
  <input class="form-control mr-sm-2" type="time" aria-label="Add" name="tasktime">
  <input class="form-control mr-sm-2" type="add" placeholder="Description" aria-label="Add" name="taskdesc">
  <input class="form-control mr-sm-2" type="add" placeholder="Location" aria-label="Add" name="location">



 <select class="form-control mr-sm-2" name="assingees" id="assingees" >
  <option value="" selected="selected">Not Selected</option>
    {% for staff in all_staff %}
        {% if staff.termindate is None %}
           <option value="{{ staff.id }}">{{ staff.staffname }}</option>
        {% endif %}
    {% endfor %}     

  <input class="form-control mr-sm-2" type="add" placeholder="Comments" aria-label="Add" name="comments">
  <button class="btn btn-secondary my-2 my-sm-0" type="submit">Add Task</button>
</form>


    <button class="btn btn-secondary my-2 my-sm-0" type="submit"><a href="{% url 'delallcomplete' %}">Delete All Completed Tasks</a></button>




</br>
  {% if all_tasks %}
  <table class="table table-bordered">

    <thead class="thead-dark">
      <tr>

        
        <th scope="col">Date</th>
        <th scope="col">Time</th>
        <th scope="col">Task</th>
        <th scope="col">Location</th>
        <th scope="col">Assigned To</th>
        <th scope="col">Status</th>
        <th scope="col">Comments</th>
        <th scope="col">Delete</th>
      </tr>
    </thead>
    
    <tbody>
      {% for tasks in all_tasks %}
        {% if tasks.completed %}
          <tr class="table table-secondary table-borderless">
           
            <td> {{tasks.taskdate|date:"d M Y"}} </td>
            <td> {{tasks.tasktime|time:"h i a"}} </td>
            <td class="strikethru"><a href="{% url 'edittask' tasks.id %}"> {{tasks.taskdesc}}</a> </td>
            <td> {{tasks.location}} </td>
            <td> {{tasks.assingees.staffname}} </td>
            <td> Done<a href="{% url 'markincomplete' tasks.id %}" style="float: right">Undo?</a></td>
            <td> {{tasks.comments}} </td>
            <td><center> <a href="{% url 'delete' tasks.id %}">X</a></center> </td>
          </tr>
      
        {% else %}
            <tr class="table table-borderless table-light" border-color>
              
              <td> {{tasks.taskdate|date:"d M Y"}} </td>
              <td> {{tasks.tasktime|time:"h i a"}} </td>
              <td> <a href="{% url 'edittask' tasks.id %}">{{tasks.taskdesc}}</a> </td>
              <td> {{tasks.location}} </td>
              <td> {{tasks.assingees.staffname}} </td>
              <td> To Do <a href="{% url 'markcomplete' tasks.id %}"style="float: right">Done?</a> </td>
              <td> {{tasks.comments}} </td>
              <td><center> <a href="{% url 'delete' tasks.id %}">X</a></center> </td>
            </tr>
        {% endif %}

      {% endfor %}
    </tbody>
  </table>
  {% endif %}


</br>

{% block javascript %}
<script>
$("#datepicker").change(function () {
  
  
  var csrftoken = Cookies.get('csrftoken');
  console.log(csrftoken);
  var task_date = $(this).val();
  console.log(task_date);

  taskdate = task_date.replace(/(\d\d)\/(\d\d)\/(\d{4})/, "$3-$1-$2");
  console.log(taskdate);


 function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

  $.ajax({
  type: "POST",
  async: false,
  url: '{% url "getselectdate" %}',
  data: {'taskdate': taskdate },
  dataType: 'json',

  success: function(avail_staff){
    console.log(avail_staff);
    var staff=avail_staff;
    
    
    //console.log(staff.avail_staff[1].staffname);

$('#assingees').empty();


$.each(staff.avail_staff, function (i, item) {

//console.log(item.staffname);
$("#assingees").append('<option value="' + item.id + '">' + item.staffname + '</option>');

});
    
   
//https://pythonspot.com/json-encoding-and-decoding-with-python/
    

  // ***** This function should clear out and append new availalbe staff values in dropdown from json array, instead appends 'undefined'  
  // ***** Hit F12 and see 'Console log' to view the array of available staff from staff rota for date selected in form 
     // $('#assingees').empty(); 
     // $.each(avail_staff, function (i, item) {
     // $("#assingees").append('<option value="' + item.id + '">' + item.staffname + '</option>');
     //                       });



   
  }



});







   
});


</script>

{% endblock %}


{% endblock %}



</body>
    


